rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Only allow writes to contacts collection from Firebase Functions
    match /contacts/{document} {
      // Allow create only (no update, no delete)
      allow create: if request.auth != null ||
        (resource == null && request.resource != null);

      // Deny all other operations
      allow read, update, delete: if false;
    }

    // Allow writes to subscribers collection from Firebase Functions
    match /subscribers/{document} {
      // Allow create and update (for newsletter management)
      allow create, update: if request.auth != null ||
        (resource == null && request.resource != null);

      // Deny read and delete
      allow read, delete: if false;
    }

    // Admin users collection - for CMS authentication
    match /adminUsers/{userId} {
      // Allow authenticated users to create their own admin user document
      allow create: if request.auth != null &&
        request.auth.uid == userId &&
        request.resource.data.keys().hasAll(['uid', 'email', 'isAdmin', 'emailVerified', 'createdAt']) &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.email == request.auth.token.email &&
        request.resource.data.isAdmin == false && // Initial creation must be false
        request.resource.data.emailVerified == false; // Initial creation must be false

      // Allow users to read their own admin user document
      allow read: if request.auth != null &&
        request.auth.uid == userId;

      // Allow users to update their own admin user document (for lastLoginAt and emailVerified updates)
      allow update: if request.auth != null &&
        request.auth.uid == userId &&
        // Only allow updating lastLoginAt and emailVerified fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLoginAt', 'emailVerified', 'isAdmin']) &&
        // Ensure core fields don't change
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.createdAt == resource.data.createdAt;

      // Deny delete operations
      allow delete: if false;
    }

    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
